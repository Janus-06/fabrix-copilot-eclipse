package com.fabrix.copilot.ui;

import org.eclipse.swt.widgets.*;
import org.eclipse.swt.layout.*;
import org.eclipse.swt.SWT;
import org.eclipse.swt.events.*;
import org.eclipse.jface.dialogs.Dialog;
import org.eclipse.jface.dialogs.IDialogConstants;

import com.fabrix.copilot.mcp.McpServerConfig;
import com.fabrix.copilot.utils.CopilotLogger;

import java.util.*;
import java.io.File;
import org.eclipse.swt.graphics.Rectangle;
import java.util.List;
/**
 * üîß MCP Server Configuration Dialog
 * 
 * MCP ÏÑúÎ≤Ñ ÏÑ§Ï†ïÏùÑ ÏûÖÎ†•/Ìé∏ÏßëÌïòÎäî Îã§Ïù¥ÏñºÎ°úÍ∑∏
 */
public class McpServerConfigDialog extends Dialog {
    
    private Text nameText;
    private Combo typeCombo;
    private Text commandText;
    private Text argsText;
    private Text envText;
    private Spinner prioritySpinner;
    private Button browseButton;
    private Button testButton;
    private Label statusLabel;
    
    private McpServerConfig serverConfig;
    private McpServerInfo serverInfo;
    
    public McpServerConfigDialog(Shell parentShell, McpServerInfo serverInfo) {
        super(parentShell);
        this.serverInfo = serverInfo;
    }
    
    @Override
    protected void configureShell(Shell shell) {
        super.configureShell(shell);
        shell.setText(serverInfo == null ? "‚ûï Add MCP Server" : "‚úèÔ∏è Edit MCP Server");
        shell.setSize(600, 500);
        
        // ÌôîÎ©¥ Ï§ëÏïôÏóê ÏúÑÏπò
        Rectangle displayBounds = shell.getDisplay().getPrimaryMonitor().getBounds();
        Rectangle shellBounds = shell.getBounds();
        int x = (displayBounds.width - shellBounds.width) / 2;
        int y = (displayBounds.height - shellBounds.height) / 2;
        shell.setLocation(x, y);
    }
    
    @Override
    protected Control createDialogArea(Composite parent) {
        Composite container = (Composite) super.createDialogArea(parent);
        container.setLayout(new GridLayout(1, false));
        
        createHeader(container);
        createBasicSettings(container);
        createAdvancedSettings(container);
        createTemplates(container);
        
        if (serverInfo != null) {
            loadExistingConfig();
        }
        
        return container;
    }
    
    /**
     * Ìó§Îçî ÏÉùÏÑ±
     */
    private void createHeader(Composite parent) {
        Label descLabel = new Label(parent, SWT.WRAP);
        descLabel.setText("Configure a local MCP server. The server process will be managed by the plugin.");
        descLabel.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        
        Label separator = new Label(parent, SWT.HORIZONTAL | SWT.SEPARATOR);
        separator.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
    }
    
    /**
     * Í∏∞Î≥∏ ÏÑ§Ï†ï
     */
    private void createBasicSettings(Composite parent) {
        Group basicGroup = new Group(parent, SWT.NONE);
        basicGroup.setText("üîß Basic Settings");
        basicGroup.setLayout(new GridLayout(2, false));
        basicGroup.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, false));
        
        // ÏÑúÎ≤Ñ Ïù¥Î¶Ñ
        Label nameLabel = new Label(basicGroup, SWT.NONE);
        nameLabel.setText("Server Name:");
        
        nameText = new Text(basicGroup, SWT.BORDER);
        nameText.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        nameText.setMessage("e.g., mcp-filesystem");
        nameText.addModifyListener(e -> validateInput());
        
        // ÏÑúÎ≤Ñ ÌÉÄÏûÖ
        Label typeLabel = new Label(basicGroup, SWT.NONE);
        typeLabel.setText("Server Type:");
        
        typeCombo = new Combo(basicGroup, SWT.READ_ONLY);
        typeCombo.setItems(new String[]{"stdio", "http", "websocket"});
        typeCombo.select(0);
        typeCombo.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        typeCombo.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                updateUIForType();
            }
        });
        
        // Ïã§Ìñâ Î™ÖÎ†π
        Label commandLabel = new Label(basicGroup, SWT.NONE);
        commandLabel.setText("Command:");
        
        Composite commandComposite = new Composite(basicGroup, SWT.NONE);
        commandComposite.setLayout(new GridLayout(2, false));
        commandComposite.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        
        commandText = new Text(commandComposite, SWT.BORDER);
        commandText.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        commandText.setMessage("e.g., node, python, npx");
        commandText.addModifyListener(e -> validateInput());
        
        browseButton = new Button(commandComposite, SWT.PUSH);
        browseButton.setText("Browse...");
        browseButton.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                browseForCommand();
            }
        });
        
        // Ïù∏Ïûê
        Label argsLabel = new Label(basicGroup, SWT.NONE);
        argsLabel.setText("Arguments:");
        
        argsText = new Text(basicGroup, SWT.BORDER | SWT.MULTI | SWT.V_SCROLL);
        GridData argsData = new GridData(SWT.FILL, SWT.FILL, true, true);
        argsData.heightHint = 60;
        argsText.setLayoutData(argsData);
        argsText.setMessage("One argument per line\ne.g.,\nC:/mcp-server/index.js\n--port\n8080");
    }
    
    /**
     * Í≥†Í∏â ÏÑ§Ï†ï
     */
    private void createAdvancedSettings(Composite parent) {
        Group advancedGroup = new Group(parent, SWT.NONE);
        advancedGroup.setText("‚öôÔ∏è Advanced Settings");
        advancedGroup.setLayout(new GridLayout(2, false));
        advancedGroup.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, false));
        
        // ÌôòÍ≤Ω Î≥ÄÏàò
        Label envLabel = new Label(advancedGroup, SWT.NONE);
        envLabel.setText("Environment Variables:");
        envLabel.setLayoutData(new GridData(SWT.LEFT, SWT.TOP, false, false));
        
        envText = new Text(advancedGroup, SWT.BORDER | SWT.MULTI | SWT.V_SCROLL);
        GridData envData = new GridData(SWT.FILL, SWT.FILL, true, true);
        envData.heightHint = 60;
        envText.setLayoutData(envData);
        envText.setMessage("KEY=VALUE format, one per line\ne.g.,\nNODE_ENV=production\nPORT=8080");
        
        // Ïö∞ÏÑ†ÏàúÏúÑ
        Label priorityLabel = new Label(advancedGroup, SWT.NONE);
        priorityLabel.setText("Priority:");
        
        prioritySpinner = new Spinner(advancedGroup, SWT.BORDER);
        prioritySpinner.setMinimum(1);
        prioritySpinner.setMaximum(10);
        prioritySpinner.setSelection(5);
        prioritySpinner.setToolTipText("Higher priority servers are preferred when multiple servers provide the same tool");
        
        // ÌÖåÏä§Ìä∏ Î≤ÑÌäº
        new Label(advancedGroup, SWT.NONE); // Spacer
        
        Composite testComposite = new Composite(advancedGroup, SWT.NONE);
        testComposite.setLayout(new GridLayout(2, false));
        testComposite.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        
        testButton = new Button(testComposite, SWT.PUSH);
        testButton.setText("üß™ Test Configuration");
        testButton.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                testConfiguration();
            }
        });
        
        statusLabel = new Label(testComposite, SWT.NONE);
        statusLabel.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
    }
    
    /**
     * ÌÖúÌîåÎ¶ø ÏÑπÏÖò
     */
    private void createTemplates(Composite parent) {
        Group templateGroup = new Group(parent, SWT.NONE);
        templateGroup.setText("üìã Templates");
        templateGroup.setLayout(new GridLayout(4, true));
        templateGroup.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        
        Button filesystemBtn = new Button(templateGroup, SWT.PUSH);
        filesystemBtn.setText("üìÅ Filesystem");
        filesystemBtn.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        filesystemBtn.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                applyFilesystemTemplate();
            }
        });
        
        Button gitBtn = new Button(templateGroup, SWT.PUSH);
        gitBtn.setText("üîß Git");
        gitBtn.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        gitBtn.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                applyGitTemplate();
            }
        });
        
        Button sqliteBtn = new Button(templateGroup, SWT.PUSH);
        sqliteBtn.setText("üóÉÔ∏è SQLite");
        sqliteBtn.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        sqliteBtn.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                applySQLiteTemplate();
            }
        });
        
        Button customBtn = new Button(templateGroup, SWT.PUSH);
        customBtn.setText("üõ†Ô∏è Custom");
        customBtn.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false));
        customBtn.addSelectionListener(new SelectionAdapter() {
            @Override
            public void widgetSelected(SelectionEvent e) {
                applyCustomTemplate();
            }
        });
    }
    
    /**
     * ÌÉÄÏûÖÏóê Îî∞Î•∏ UI ÏóÖÎç∞Ïù¥Ìä∏
     */
    private void updateUIForType() {
        String type = typeCombo.getText();
        
        switch (type) {
            case "http":
            case "websocket":
                // HTTP/WebSocketÏùò Í≤ΩÏö∞ Ï∂îÍ∞Ä ÏÑ§Ï†ï
                argsText.setMessage("URL and port configuration\ne.g.,\n--host\nlocalhost\n--port\n8080");
                break;
            case "stdio":
            default:
                argsText.setMessage("One argument per line");
                break;
        }
    }
    
    /**
     * Î™ÖÎ†πÏñ¥ Ï∞æÏïÑÎ≥¥Í∏∞
     */
    private void browseForCommand() {
        FileDialog dialog = new FileDialog(getShell(), SWT.OPEN);
        dialog.setFilterExtensions(new String[]{"*.exe", "*.bat", "*.sh", "*.*"});
        dialog.setText("Select Command");
        
        String selected = dialog.open();
        if (selected != null) {
            commandText.setText(selected);
        }
    }
    
    /**
     * ÏûÖÎ†• Í≤ÄÏ¶ù
     */
    private void validateInput() {
        boolean valid = true;
        
        if (nameText.getText().trim().isEmpty()) {
            valid = false;
        }
        
        if (commandText.getText().trim().isEmpty()) {
            valid = false;
        }
        
        Button okButton = getButton(IDialogConstants.OK_ID);
        if (okButton != null) {
            okButton.setEnabled(valid);
        }
    }
    
    /**
     * ÏÑ§Ï†ï ÌÖåÏä§Ìä∏
     */
    private void testConfiguration() {
        statusLabel.setText("üîÑ Testing...");
        statusLabel.setForeground(statusLabel.getDisplay().getSystemColor(SWT.COLOR_BLUE));
        
        // ÎπÑÎèôÍ∏∞ ÌÖåÏä§Ìä∏
        new Thread(() -> {
            try {
                // Í∞ÑÎã®Ìïú ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ìñâ ÌÖåÏä§Ìä∏
                ProcessBuilder pb = new ProcessBuilder(commandText.getText().trim());
                
                // Ïù∏Ïûê Ï∂îÍ∞Ä
                String[] args = argsText.getText().split("\n");
                for (String arg : args) {
                    if (!arg.trim().isEmpty()) {
                        pb.command().add(arg.trim());
                    }
                }
                
                // ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
                Map<String, String> env = pb.environment();
                String[] envLines = envText.getText().split("\n");
                for (String envLine : envLines) {
                    if (envLine.contains("=")) {
                        String[] parts = envLine.split("=", 2);
                        env.put(parts[0].trim(), parts[1].trim());
                    }
                }
                
                // ÌÖåÏä§Ìä∏ Ïã§Ìñâ
                Process process = pb.start();
                Thread.sleep(1000); // 1Ï¥à ÎåÄÍ∏∞
                
                boolean alive = process.isAlive();
                if (alive) {
                    process.destroyForcibly();
                }
                
                Display.getDefault().asyncExec(() -> {
                    if (alive) {
                        statusLabel.setText("‚úÖ Configuration valid");
                        statusLabel.setForeground(statusLabel.getDisplay().getSystemColor(SWT.COLOR_DARK_GREEN));
                    } else {
                        statusLabel.setText("‚ö†Ô∏è Process exited immediately");
                        statusLabel.setForeground(statusLabel.getDisplay().getSystemColor(SWT.COLOR_DARK_YELLOW));
                    }
                });
                
            } catch (Exception e) {
                Display.getDefault().asyncExec(() -> {
                    statusLabel.setText("‚ùå Test failed: " + e.getMessage());
                    statusLabel.setForeground(statusLabel.getDisplay().getSystemColor(SWT.COLOR_RED));
                });
            }
        }).start();
    }
    
    /**
     * Í∏∞Ï°¥ ÏÑ§Ï†ï Î°úÎìú
     */
    private void loadExistingConfig() {
        if (serverInfo != null) {
            nameText.setText(serverInfo.name);
            typeCombo.setText(serverInfo.type);
            commandText.setText(serverInfo.command);
            if (serverInfo.args != null) {
                argsText.setText(serverInfo.args.replace(" ", "\n"));
            }
        }
    }
    
    /**
     * ÌååÏùºÏãúÏä§ÌÖú ÌÖúÌîåÎ¶ø Ï†ÅÏö©
     */
    private void applyFilesystemTemplate() {
        nameText.setText("mcp-filesystem");
        typeCombo.select(0); // stdio
        commandText.setText("npx");
        argsText.setText("-y\n@modelcontextprotocol/server-filesystem\n./");
        prioritySpinner.setSelection(5);
    }
    
    /**
     * Git ÌÖúÌîåÎ¶ø Ï†ÅÏö©
     */
    private void applyGitTemplate() {
        nameText.setText("mcp-git");
        typeCombo.select(0); // stdio
        commandText.setText("npx");
        argsText.setText("-y\n@modelcontextprotocol/server-git");
        prioritySpinner.setSelection(5);
    }
    
    /**
     * SQLite ÌÖúÌîåÎ¶ø Ï†ÅÏö©
     */
    private void applySQLiteTemplate() {
        nameText.setText("mcp-sqlite");
        typeCombo.select(0); // stdio
        commandText.setText("npx");
        argsText.setText("-y\n@modelcontextprotocol/server-sqlite\n--db\n./database.db");
        prioritySpinner.setSelection(5);
    }
    
    /**
     * ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌÖúÌîåÎ¶ø
     */
    private void applyCustomTemplate() {
        nameText.setText("mcp-custom");
        typeCombo.select(0); // stdio
        commandText.setText("node");
        argsText.setText("path/to/your/mcp-server.js");
        prioritySpinner.setSelection(5);
        envText.setText("NODE_ENV=production");
    }
    
    @Override
    protected void createButtonsForButtonBar(Composite parent) {
        createButton(parent, IDialogConstants.OK_ID, serverInfo == null ? "Add" : "Save", true);
        createButton(parent, IDialogConstants.CANCEL_ID, "Cancel", false);
        
        validateInput();
    }
    
    @Override
    protected void okPressed() {
        // ÏÑúÎ≤Ñ ÏÑ§Ï†ï ÏÉùÏÑ±
        List<String> args = new ArrayList<>();
        String[] argLines = argsText.getText().split("\n");
        for (String arg : argLines) {
            if (!arg.trim().isEmpty()) {
                args.add(arg.trim());
            }
        }
        
        Map<String, String> env = new HashMap<>();
        String[] envLines = envText.getText().split("\n");
        for (String envLine : envLines) {
            if (envLine.contains("=")) {
                String[] parts = envLine.split("=", 2);
                env.put(parts[0].trim(), parts[1].trim());
            }
        }
        
        serverConfig = new McpServerConfig(
            nameText.getText().trim(),
            typeCombo.getText(),
            commandText.getText().trim(),
            args,
            env,
            prioritySpinner.getSelection()
        );
        
        CopilotLogger.info("MCP server configured: " + serverConfig.getName());
        
        super.okPressed();
    }
    
    /**
     * ÏÑ§Ï†ïÎêú ÏÑúÎ≤Ñ ÏÑ§Ï†ï Î∞òÌôò
     */
    public McpServerConfig getServerConfig() {
        return serverConfig;
    }
}